(function(root,factory){
  if(typeof define==='function'&&define.amd){
    define(['grapesjs'],factory);
  }else if(typeof exports==='object'){
    module.exports=factory;
  }else{
    factory(root.grapesjs);
  }
})(this,function(grapesjs){
  if(!grapesjs){
    return;
  }
  var pad=function(value){
    return value<10?'0'+value:value;
  };
  grapesjs.plugins.add('grapesjs-component-countdown',function(editor,opts){
    var bm=editor.BlockManager;
    var domc=editor.DomComponents;
    var defaultDate=new Date(Date.now()+7*24*60*60*1000).toISOString();
    domc.addType('countdown',{model:{defaults:{tagName:'div',attributes:{class:'countdown','data-gjs-type':'countdown','data-date':defaultDate},droppable:false,draggable:true,highlightable:false,script:function(){
      var element=this;
      var targetDate=new Date(element.getAttribute('data-date'));
      var daysEl=element.querySelector('[data-countdown-days]');
      var hoursEl=element.querySelector('[data-countdown-hours]');
      var minutesEl=element.querySelector('[data-countdown-minutes]');
      var secondsEl=element.querySelector('[data-countdown-seconds]');
      var update=function(){
        var diff=targetDate.getTime()-new Date().getTime();
        if(diff<=0){
          diff=0;
          clearInterval(timer);
        }
        var seconds=Math.floor(diff/1000)%60;
        var minutes=Math.floor(diff/(1000*60))%60;
        var hours=Math.floor(diff/(1000*60*60))%24;
        var days=Math.floor(diff/(1000*60*60*24));
        if(daysEl){daysEl.innerHTML=pad(days);}
        if(hoursEl){hoursEl.innerHTML=pad(hours);}
        if(minutesEl){minutesEl.innerHTML=pad(minutes);}
        if(secondsEl){secondsEl.innerHTML=pad(seconds);}
      };
      var timer=setInterval(update,1000);
      update();
    },components:[
      {tagName:'div',attributes:{class:'countdown-inner'},components:[
        {tagName:'div',attributes:{class:'countdown-item'},components:[
          {tagName:'div',attributes:{class:'countdown-value','data-countdown-days':''},components:'07'},
          {tagName:'div',attributes:{class:'countdown-label'},components:'Days'}
        ]},
        {tagName:'div',attributes:{class:'countdown-item'},components:[
          {tagName:'div',attributes:{class:'countdown-value','data-countdown-hours':''},components:'00'},
          {tagName:'div',attributes:{class:'countdown-label'},components:'Hours'}
        ]},
        {tagName:'div',attributes:{class:'countdown-item'},components:[
          {tagName:'div',attributes:{class:'countdown-value','data-countdown-minutes':''},components:'00'},
          {tagName:'div',attributes:{class:'countdown-label'},components:'Minutes'}
        ]},
        {tagName:'div',attributes:{class:'countdown-item'},components:[
          {tagName:'div',attributes:{class:'countdown-value','data-countdown-seconds':''},components:'00'},
          {tagName:'div',attributes:{class:'countdown-label'},components:'Seconds'}
        ]}
      ]
    ],styles:'.countdown{display:flex;justify-content:center;gap:20px;padding:30px;background:#1f2933;color:#fff;text-align:center;border-radius:6px;} .countdown .countdown-item{min-width:80px;} .countdown .countdown-value{font-size:32px;font-weight:600;margin-bottom:6px;} .countdown .countdown-label{text-transform:uppercase;font-size:12px;letter-spacing:1px;color:rgba(255,255,255,0.75);}'}});
    if(!bm.get('gjs-countdown')){
      bm.add('gjs-countdown',{
        label:'Countdown',
        category:'Extra',
        attributes:{class:'gjs-fonts gjs-f-countdown'},
        content:{type:'countdown'}
      });
    }
  });
});
