(function(root, factory){
  if (typeof define === 'function' && define.amd) {
    define(['grapesjs'], factory);
  } else if (typeof exports === 'object') {
    module.exports = factory;
  } else {
    factory(root.grapesjs);
  }
})(typeof self !== 'undefined' ? self : this, function(grapesjs){
  if (!grapesjs || !grapesjs.plugins) {
    return;
  }

  grapesjs.plugins.add('grapesjs-style-flexbox', function(editor){
    if (!editor) {
      return;
    }

    var sm = editor.StyleManager;
    if (!sm) {
      return;
    }

    var sectorFlex = sm.getSector('flexbox');
    if (!sectorFlex) {
      sm.addSector('flexbox', {
        name: 'Flex Container',
        open: false,
        buildProps: [],
        properties: [
          {
            property: 'display',
            type: 'radio',
            default: 'flex',
            options: [
              { id: 'block', label: 'Block' },
              { id: 'flex', label: 'Flex' },
              { id: 'inline-flex', label: 'Inline' }
            ]
          },
          {
            property: 'flex-direction',
            type: 'radio',
            default: 'row',
            options: [
              { id: 'row', label: 'Row' },
              { id: 'row-reverse', label: 'Row Reverse' },
              { id: 'column', label: 'Column' },
              { id: 'column-reverse', label: 'Column Reverse' }
            ]
          },
          {
            property: 'flex-wrap',
            type: 'radio',
            default: 'nowrap',
            options: [
              { id: 'nowrap', label: 'No wrap' },
              { id: 'wrap', label: 'Wrap' },
              { id: 'wrap-reverse', label: 'Wrap Reverse' }
            ]
          },
          {
            property: 'justify-content',
            type: 'radio',
            default: 'flex-start',
            options: [
              { id: 'flex-start', label: 'Start' },
              { id: 'flex-end', label: 'End' },
              { id: 'center', label: 'Center' },
              { id: 'space-between', label: 'Space Between' },
              { id: 'space-around', label: 'Space Around' },
              { id: 'space-evenly', label: 'Space Evenly' }
            ]
          },
          {
            property: 'align-items',
            type: 'radio',
            default: 'stretch',
            options: [
              { id: 'stretch', label: 'Stretch' },
              { id: 'flex-start', label: 'Start' },
              { id: 'flex-end', label: 'End' },
              { id: 'center', label: 'Center' },
              { id: 'baseline', label: 'Baseline' }
            ]
          },
          {
            property: 'align-content',
            type: 'radio',
            default: 'stretch',
            options: [
              { id: 'stretch', label: 'Stretch' },
              { id: 'flex-start', label: 'Start' },
              { id: 'flex-end', label: 'End' },
              { id: 'center', label: 'Center' },
              { id: 'space-between', label: 'Space Between' },
              { id: 'space-around', label: 'Space Around' }
            ]
          }
        ]
      });
    }

    var sectorItem = sm.getSector('flexbox-item');
    if (!sectorItem) {
      sm.addSector('flexbox-item', {
        name: 'Flex Item',
        open: false,
        buildProps: [],
        properties: [
          {
            property: 'order',
            type: 'integer',
            defaults: 0,
            min: -10,
            max: 10,
            step: 1
          },
          {
            property: 'flex-basis',
            type: 'text',
            defaults: 'auto',
            placeholder: 'auto | px | %'
          },
          {
            property: 'flex-grow',
            type: 'integer',
            defaults: 0,
            min: 0,
            max: 10,
            step: 1
          },
          {
            property: 'flex-shrink',
            type: 'integer',
            defaults: 1,
            min: 0,
            max: 10,
            step: 1
          },
          {
            property: 'align-self',
            type: 'radio',
            defaults: 'auto',
            options: [
              { id: 'auto', label: 'Auto' },
              { id: 'flex-start', label: 'Start' },
              { id: 'flex-end', label: 'End' },
              { id: 'center', label: 'Center' },
              { id: 'baseline', label: 'Baseline' },
              { id: 'stretch', label: 'Stretch' }
            ]
          }
        ]
      });
    }

    editor.on('component:selected', function(component){
      if (!component) {
        return;
      }

      var style = component.getStyle();
      if (!style) {
        return;
      }

      if (style.display === 'flex' || style.display === 'inline-flex') {
        var flexSector = sm.getSector('flexbox');
        if (flexSector) {
          flexSector.set('open', true);
        }
      }
    });
  });
});
